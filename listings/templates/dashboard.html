{% extends "base_webapp.html" %}
{% load static %}


{% block page_title %}
    <span>üè† Home</span>
    <div class="float-end d-flex align-items-center">
        <!-- Bouton Ajouter -->
        <a class="btn btn-sm btn-outline-blue me-2" href="{% url 'create_brokenscreen' %}">
            <span class="me-2">üì≤</span>
            <span>Ajouter un √©cran</span>
        </a>

        <!-- Bouton Exp√©dier -->
        <a class="btn btn-sm btn-outline-blue me-2{% if broken_screens.count == 0 %} disabled{% endif %}" href="{% url 'expedier_mes_ecrans' %}">
            <span class="me-2">üì¶</span>
            <span>Exp√©dier mes √©crans</span>
        </a>

        <!-- Champ de recherche -->
<form class="d-flex me-2" id="searchForm">
    <input 
        type="text" 
        class="form-control custom-search-input btn btn-sm btn-outline-blue" 
        placeholder="Rechercher un √©cran..." 
        aria-label="Trouver un √©cran" 
        aria-describedby="button-addon2" 
        id="searchInput"
    >
    <button 
        class="btn btn-sm btn-outline-secondary" 
        type="submit" 
        id="button-addon2"
    >
        üîç
    </button>
</form>

<!-- Message d'erreur -->
<div id="errorMessage" class="error-message">
    La r√©f√©rence ne correspond pas ou n'existe pas.
</div>

<style>
    .error-message {
        color: red;
        font-size: 12px;
        font-weight: bold;
        display: none;
    }
</style>

<script>
    document.getElementById('searchForm').addEventListener('submit', function(event) {
    // Emp√™cher le formulaire de se soumettre normalement
    event.preventDefault();

    // R√©cup√©rer la valeur de la r√©f√©rence entr√©e par l'utilisateur
    var reference = document.getElementById('searchInput').value;

    // V√©rifier si la r√©f√©rence n'est pas vide
    if (reference.trim() !== '') {
        // Construire l'URL avec la r√©f√©rence
        var url = 'http://127.0.0.1:8000/brokenscreen/detail/' + encodeURIComponent(reference);

        // Effectuer une requ√™te HEAD pour v√©rifier le statut HTTP
        var xhr = new XMLHttpRequest();
        xhr.open('HEAD', url, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    // Rediriger l'utilisateur vers l'URL construit si la r√©f√©rence existe
                    window.location.href = url;
                } else {
                    // Afficher le message d'erreur comme une popup si la r√©f√©rence n'existe pas (404)
                    alert('La r√©f√©rence ne correspond pas ou n\'existe pas.');
                }
            }
        };
        xhr.send();
    } else {
        // Afficher le message d'erreur comme une popup si la r√©f√©rence est vide
        alert('Veuillez entrer une r√©f√©rence.');
    }
});
</script>
{% endblock %}




{% block page_content %}
    <!-- DEBUT Stock & Opportunit√©s -->
    <div class="row mb-4">
        <!-- DEBUT Stock -->
        <div class="col-12 col-md-6 col-lg-4 mb-4">
            <ul class="list-group font-monospace shadow-sm">
                <li class="list-group-item logo-blue fs-5">üí≤ Stock {% if brand %}{{ brand.screenmodel|title }}{% elif recycler %}{{ recycler|title }}{% else %}total{% endif %}</li>
                <li class="list-group-item fs-6">
                    <span>Nombre d'√©crans</span>
                    <span class="float-end">{{ items_count }}</span>
                </li>
                <li class="list-group-item fs-6">
                    <span>Valeur totale estim√©e</span>
                    <span class="float-end">{{ items_value |floatformat:2}} ‚Ç¨</span>
                </li>
                {% if request.resolver_match.url_name == 'dashboard' %}
                    <li class="list-group-item text-end">
                        <a href="{% url 'stock_all' %}" class="btn btn-sm btn-outline-blue{% if items_count == 0 %} disabled{% endif %}">Voir en d√©tail</a>
                    </li>
                {% endif %}
            </ul>
        </div>
        <!-- DEBUT Opportunit√©s -->
        <div class="col-12 col-md-6 col-lg-4 mb-4 fs-5 text-blue">
            <ul class="list-group font-monospace shadow-sm">
                <li class="list-group-item logo-blue fs-5">üåü Opportunit√©s</li>
                <li class="list-group-item fs-6">
                    <span>Nombre d'opportunit√©s</span>
                    <span class="float-end">{{ opportunities_count }}</span>
                </li>
                <li class="list-group-item fs-6">
                    <span>Gain potentiel estim√©</span>
                    <span class="fw-bold text-success float-end">+ {{ opportunities_value |floatformat:2 }} ‚Ç¨</span>
                </li>
                <li class="list-group-item text-end">
                    <a href="{% url 'opportunities' %}" class="btn btn-sm btn-outline-blue{% if opportunities_count == 0 %} disabled{% endif %}">Voir en d√©tail</a>
                </li>
            </ul>
        </div>
    </div>

    {% if recap_brand_table|length > 0 %}
        <!-- Stock Marque -->
        <div class="row mb-4">
            <div class="mb-3 fs-5 text-blue">üì± Stock par marque</div>
            
            {% for brand_info in recap_brand_table %}
                <div class="col-12 col-md-6 col-lg-4 mb-4">
                    <ul class="list-group font-monospace shadow-sm">
                        <li class="list-group-item logo-blue fs-5">
                            <img src="{% static 'img/brand_logos/' %}{{ brand_info.screenmodel__screenbrand }}.svg" class="me-2" width="20px" height="20px">{{ brand_info.screenmodel__screenbrand|title }}
                        </li>
                        <li class="list-group-item fs-6">
                            <span>Nombre d'√©crans</span>
                            <span class="float-end">{{ brand_info.items_count_brand }}</span>
                        </li>
                        <li class="list-group-item fs-6">
                            <span>Valeur totale estim√©e</span>
                            <span class="float-end">{{ brand_info.total_value |floatformat:2}} ‚Ç¨</span>
                        </li>
                        <li class="list-group-item text-end">
                            <a href="{% url 'stock_brand' brand_ref=brand_info.screenmodel__screenbrand %}" class="btn btn-sm btn-outline-blue">Voir en d√©tail</a>
                        </li>
                    </ul>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- Aucun √©cran en stock pour le moment, affichez un tableau avec des valeurs par d√©faut -->
        <div class="row mb-4">
            <div class="col-12 col-md-6 col-lg-4">
                <ul class="list-group font-monospace shadow-sm">
                    <li class="list-group-item logo-blue fs-5">
                        <span>Stock par Marque</span>
                    </li>
                    <li class="list-group-item fs-6">
                        <span>Nombre d'√©crans</span>
                        <span class="float-end">0</span>
                    </li>
                    <li class="list-group-item fs-6">
                        <span>Valeur totale estim√©e</span>
                        <span class="float-end">0.00 ‚Ç¨</span>
                    </li>
                    <li class="list-group-item text-end">
                        <span class="btn btn-sm btn-outline-blue disabled">Voir en d√©tail</span>
                    </li>
                </ul>
            </div>
        </div>
    {% endif %}

    {% if recap_recycler_table|length > 0 %}
        <!-- Stock Recycleur -->
        <div class="row mb-4">
            <div class="mb-3 fs-5 text-blue">üë®‚Äçüîß Stock par recycleur</div>
            
            {% for recycler_info in recap_recycler_table %}
                <div class="col-12 col-md-6 col-lg-4 mb-4">
                    <ul class="list-group font-monospace shadow-sm">
                        <li class="list-group-item logo-blue fs-5">
                            {% if recycler_info.recycler__company_name is None %}
                                <span class="me-2">‚ùì</span>
                            {% else %}
                            <img src="{% static 'img/recycler_logos/'|add:recycler_info.recycler__company_name|lower|add:'.png' %}" alt="Logo Recycleur" class="me-2" width="50" height="20">
                            {% endif %}
                            <span>{{ recycler_info.recycler__company_name|default_if_none:"Non attribu√©"|title }}</span>
                        </li>
                        <li class="list-group-item fs-6">
                            <span>Nombre d'√©crans</span>
                            <span class="float-end">{{ recycler_info.items_count_brand }}</span>
                        </li>
                        <li class="list-group-item fs-6">
                            <span>Valeur totale estim√©e</span>
                            {% if recycler_info.total_value_recycler == 0 %}
                                <span class="float-end">‚ùì</span>
                            {% else %}
                                <span class="float-end">{{ recycler_info.total_value_recycler|default_if_none:'0'|floatformat:2 }} ‚Ç¨</span>
                            {% endif %}
                        </li>
                        <li class="list-group-item text-end">
                            {% if recycler_info.recycler__company_name %}
                                <a href="{% url 'stock_recycler' recycler_ref=recycler_info.recycler__company_name %}" class="btn btn-sm btn-outline-blue">Voir en d√©tail</a>
                            {% else %}
                                <span class="btn btn-sm btn-outline-blue disabled">Voir en d√©tail</span>
                            {% endif %}
                        </li>
                        
                    </ul>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- Aucun √©cran en stock pour le moment, affichez un tableau avec des valeurs par d√©faut -->
        <div class="row mb-4">
            <div class="col-12 col-md-6 col-lg-4">
                <ul class="list-group font-monospace shadow-sm">
                    <li class="list-group-item logo-blue fs-5">
                        <span>Stock par Recycleur</span>
                    </li>
                    <li class="list-group-item fs-6">
                        <span>Nombre d'√©crans</span>
                        <span class="float-end">0</span>
                    </li>
                    <li class="list-group-item fs-6">
                        <span>Valeur totale estim√©e</span>
                        <span class="float-end">0.00 ‚Ç¨</span>
                    </li>
                    <li class="list-group-item text-end">
                        <span class="btn btn-sm btn-outline-blue disabled">Voir en d√©tail</span>
                    </li>
                </ul>
            </div>
        </div>
    {% endif %}

    {% if recap_poubelle_table|length > 0 %}
    <!-- Stock Poubelle -->
    <div class="row mb-4">
        <div class="mb-3 fs-5 text-blue">üóëÔ∏è Stock Poubelle</div>

        {% for poubelle_info in recap_poubelle_table %}
            <div class="col-12 col-md-6 col-lg-4 mb-4">
                <ul class="list-group font-monospace shadow-sm">
                    <li class="list-group-item logo-blue fs-5">
                        <span class="me-2">üóëÔ∏è</span>
                        <span>{{ poubelle_info.recycler__company_name|title }}</span>
                    </li>
                    <li class="list-group-item fs-6">
                        <span>Nombre d'√©crans</span>
                        <span class="float-end">{{ poubelle_info.items_count_poubelle }}</span>
                    </li>
                    <li class="list-group-item fs-6">
                        <span>Valeur totale estim√©e</span>
                        {% if poubelle_info.total_value_poubelle == 0 %}
                            <span class="float-end">‚ùì</span>
                        {% else %}
                            <span class="float-end">{{ poubelle_info.total_value_poubelle|default_if_none:'0'|floatformat:2 }} ‚Ç¨</span>
                        {% endif %}
                    </li>
                    <li class="list-group-item text-end">
                        <a href="{% url 'stock_recycler' recycler_ref=poubelle_info.recycler__company_name %}" class="btn btn-sm btn-outline-blue">Voir en d√©tail</a>
                    </li>
                </ul>
            </div>
        {% endfor %}
    </div>
{% endif %}

{% endblock page_content %}
